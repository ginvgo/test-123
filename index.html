<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å®æ—¶æ ¸å¯¹è®°åˆ†å™¨</title>
    <style>
        :root { --primary: #1890ff; --danger: #ff4d4f; --success: #52c41a; --warning: #faad14; --text: #262626; --bg: #f2f4f7; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); margin: 0; padding: 12px; color: var(--text); overflow-x: hidden; }
        
        /* é¡¶éƒ¨é…ç½® */
        .card { background: white; border-radius: 16px; padding: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); margin-bottom: 12px; }
        .header-group { display: flex; gap: 8px; }
        .inp-name { flex: 1; border: 1px solid #d9d9d9; border-radius: 10px; padding: 10px; font-size: 16px; min-width: 0; }
        .btn-add { background: var(--primary); color: white; border: none; border-radius: 10px; padding: 0 16px; font-weight: bold; white-space: nowrap; }
        
        /* æˆå‘˜å¡ç‰‡ */
        .user-card { background: white; border-radius: 16px; padding: 16px; margin-bottom: 12px; border: 1px solid #f0f0f0; border-left: 6px solid var(--theme-color); }
        .user-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .u-name { font-size: 1.1rem; font-weight: bold; color: var(--theme-color); }
        .u-score { font-size: 1.8rem; font-weight: 800; color: var(--theme-color); }

        .control-bar { display: flex; align-items: center; gap: 8px; margin-bottom: 12px; }
        .btn-main { width: 55px; height: 50px; border: none; border-radius: 12px; font-size: 24px; color: white; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .btn-sub { background: var(--danger); box-shadow: 0 3px 0 #cf1322; }
        .btn-plus { background: var(--success); box-shadow: 0 3px 0 #389e0d; }
        .btn-main:active { transform: translateY(2px); box-shadow: none; }
        .val-input { flex: 1; min-width: 0; height: 50px; font-size: 20px; font-weight: bold; border: 2px solid #f0f0f0; background: #fafafa; border-radius: 12px; text-align: center; }

        /* å¿«æ·æ•°å­— */
        .quick-nums { display: flex; gap: 6px; overflow-x: auto; padding-bottom: 4px; scrollbar-width: none; }
        .num-chip { padding: 6px 12px; background: #f0f2f5; border-radius: 20px; font-size: 13px; color: #595959; flex-shrink: 0; border: 1px solid #e8e8e8; }

        /* å®æ—¶æ ¸å¯¹æ¡ - åŠ¨æ€æ˜¾ç¤º */
        .check-alert { display: none; padding: 10px; border-radius: 10px; margin-bottom: 12px; font-weight: bold; text-align: center; font-size: 14px; }
        .check-warning { display: block; background: #fffbe6; border: 1px solid #ffe58f; color: #856404; }

        /* ç»“ç®—åŒº */
        .settle-area { background: #1a1a1a; color: #fff; border-radius: 20px; padding: 20px; margin-top: 20px; margin-bottom: 40px; }
        .settle-row { display: flex; justify-content: space-between; margin-bottom: 10px; border-bottom: 1px solid #333; padding-bottom: 5px; }
        .win { color: var(--success); } .loss { color: var(--danger); }
    </style>
</head>
<body>

<div class="card">
    <div class="header-group">
        <input type="text" id="nameInp" class="inp-name" placeholder="æˆå‘˜å§“å...">
        <button class="btn-add" onclick="addUser()">æ·»åŠ </button>
    </div>
    <div style="margin-top:12px; font-size:14px; color:#666; display:flex; justify-content: space-between;">
        <span>å€ç‡ï¼š<input type="number" id="rateInp" step="0.1" style="width:60px; text-align:center;" value="1"></span>
        <span style="color:#aaa" onclick="resetAll()">é‡ç½®æ¸…ç©º</span>
    </div>
</div>

<div id="checkInpAlert" class="check-alert"></div>

<div id="userList"></div>

<div class="settle-area">
    <div style="font-weight:bold; margin-bottom:12px; display:flex; justify-content:space-between;">
        <span>ğŸ ç»“ç®—æµæ°´</span>
        <span id="totalCheckStatus" style="font-size:12px;"></span>
    </div>
    <div id="settleList"></div>
</div>

<script>
    const colors = ['#1890ff', '#f5222d', '#52c41a', '#faad14', '#722ed1', '#13c2c2', '#eb2f96', '#fa8c16'];
    let state = JSON.parse(localStorage.getItem('ScoreRealCheck_v9')) || { users: [], rate: 1 };

    function sync() {
        localStorage.setItem('ScoreRealCheck_v9', JSON.stringify(state));
        render();
    }

    function addUser() {
        const name = document.getElementById('nameInp').value.trim();
        if(!name) return;
        state.users.push({ 
            id: Date.now(), name, score: 0, logs: [], lastVal: 10, color: colors[state.users.length % colors.length] 
        });
        document.getElementById('nameInp').value = '';
        sync();
    }

    function mod(id, isAdd) {
        const user = state.users.find(u => u.id === id);
        const val = parseFloat(document.getElementById(`inp-${id}`).value) || 0;
        user.lastVal = val;
        const change = isAdd ? val : -val;
        user.score += change;
        user.logs.unshift({ id: Date.now(), time: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}), val: change });
        sync();
    }

    function revoke(userId, logId) {
        const user = state.users.find(u => u.id === userId);
        const log = user.logs.find(l => l.id === logId);
        if (log) {
            user.score -= log.val;
            user.logs = user.logs.filter(l => l.id !== logId);
            sync();
        }
    }

    function render() {
        document.getElementById('rateInp').value = state.rate;
        const quickValues = [1, 2, 3, 5, 10, 20, 50, 100];
        let totalScoreSum = 0;

        document.getElementById('userList').innerHTML = state.users.map(u => {
            totalScoreSum += u.score;
            return `
            <div class="user-card" style="--theme-color: ${u.color}">
                <div class="user-header">
                    <span class="u-name">${u.name} <small style="font-weight:normal;color:#ccc;margin-left:8px" onclick="delUser(${u.id})">åˆ é™¤</small></span>
                    <div class="u-score">${u.score}</div>
                </div>
                <div class="control-bar">
                    <button class="btn-main btn-sub" onclick="mod(${u.id}, false)">âˆ’</button>
                    <input type="number" class="val-input" id="inp-${u.id}" value="${u.lastVal}" style="color:${u.color}">
                    <button class="btn-main btn-plus" onclick="mod(${u.id}, true)">ï¼‹</button>
                </div>
                <div class="quick-nums">
                    ${quickValues.map(v => `<div class="num-chip" onclick="setQuickVal(${u.id}, ${v})">${v}</div>`).join('')}
                </div>
                <div style="text-align:center; padding-top:10px; font-size:12px; color:#ccc" onclick="toggleHist(${u.id})">â–¼ æŸ¥çœ‹æµæ°´/æ’¤é”€</div>
                <div class="hist-content" id="content-${u.id}" style="display:none; font-size:12px; background:#fafafa; border-radius:8px; padding:8px; margin-top:10px;">
                    ${u.logs.map(l => `<div style="display:flex; justify-content:space-between; padding:4px 0; border-bottom:1px dashed #eee;"><span>${l.time}</span><span>${l.val>0?'+':''}${l.val}</span><span style="color:red" onclick="revoke(${u.id}, ${l.id})">æ’¤é”€</span></div>`).join('') || 'æš‚æ— è®°å½•'}
                </div>
            </div>`;
        }).join('');

        // å®æ—¶æ ¸å¯¹é€»è¾‘
        const alertBox = document.getElementById('checkInpAlert');
        const statusText = document.getElementById('totalCheckStatus');
        
        if (state.users.length > 0 && Math.abs(totalScoreSum) > 0.001) {
            alertBox.innerText = `âš ï¸ è´¦ç›®ä¸å¹³ï¼šå½“å‰æ€»è®¡ ${totalScoreSum > 0 ? '+' : ''}${totalScoreSum.toFixed(1)}ï¼Œè¯·æ ¸å¯¹ï¼`;
            alertBox.className = 'check-alert check-warning';
            statusText.innerText = `æœªå¹³: ${totalScoreSum.toFixed(1)}`;
            statusText.style.color = 'var(--danger)';
        } else {
            alertBox.className = 'check-alert'; // è‡ªåŠ¨éšè—
            statusText.innerText = totalScoreSum === 0 && state.users.length > 0 ? 'âœ… å·²å¹³' : '';
            statusText.style.color = 'var(--success)';
        }

        // ç»“ç®—åˆ—è¡¨
        document.getElementById('settleList').innerHTML = state.users.map(u => {
            const final = (u.score * state.rate).toFixed(2);
            return `<div class="settle-row"><span style="color:${u.color}">${u.name}</span><span class="${final>=0?'win':'loss'}">${final>=0?'+':''}${final}</span></div>`;
        }).join('') || '<div style="color:#666">è¯·æ·»åŠ æˆå‘˜</div>';
    }

    function setQuickVal(id, v) { document.getElementById('inp-'+id).value = v; state.users.find(u => u.id === id).lastVal = v; localStorage.setItem('ScoreRealCheck_v9', JSON.stringify(state)); }
    function delUser(id) { if(confirm('ç¡®è®¤åˆ é™¤ï¼Ÿ')) { state.users = state.users.filter(u => u.id !== id); sync(); } }
    function resetAll() { if(confirm('é‡ç½®æ‰€æœ‰ï¼Ÿ')) { state = { users: [], rate: 1 }; sync(); } }
    function toggleHist(id) { const c = document.getElementById('content-'+id); c.style.display = c.style.display === 'block' ? 'none' : 'block'; }
    document.getElementById('rateInp').oninput = (e) => { state.rate = parseFloat(e.target.value) || 0; sync(); };

    render();
</script>
</body>
</html>
