<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è®°åˆ†</title>
    <style>
        :root { --primary: #1890ff; --danger: #ff4d4f; --success: #52c41a; --text: #262626; --bg: #f2f4f7; --warning: #faad14; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); margin: 0; padding: 12px; color: var(--text); overflow-x: hidden; }
        
        /* é¡¶éƒ¨ç®¡ç†å¡ç‰‡ */
        .card { background: white; border-radius: 16px; padding: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); margin-bottom: 12px; }
        .header-group { display: flex; gap: 8px; }
        .inp-name { flex: 1; border: 1px solid #d9d9d9; border-radius: 10px; padding: 10px; font-size: 16px; min-width: 0; }
        .btn-add { background: var(--primary); color: white; border: none; border-radius: 10px; padding: 0 16px; font-weight: bold; white-space: nowrap; }
        
        /* æ•°æ®å¹³è¡¡æé†’æ ·å¼ */
        .balance-check { font-size: 12px; margin-top: 8px; padding: 4px 8px; border-radius: 6px; display: inline-block; }
        .balance-ok { color: var(--success); background: #f6ffed; border: 1px solid #b7eb8f; }
        .balance-err { color: var(--danger); background: #fff1f0; border: 1px solid #ffa39e; animation: shake 0.3s; }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-4px); }
            75% { transform: translateX(4px); }
        }

        /* æ–°å¢ï¼šå°å¼¹çª— Toast æ ·å¼ */
        #toast-container {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.75); color: white; padding: 12px 24px;
            border-radius: 25px; z-index: 9999; display: none; pointer-events: none;
            font-weight: bold; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        /* æˆå‘˜å¡ç‰‡è®¾è®¡ */
        .user-card { 
            background: white; border-radius: 16px; padding: 16px; margin-bottom: 12px; 
            border: 1px solid #f0f0f0; position: relative; overflow: hidden;
            border-left: 2px solid var(--theme-color);
        }
        .user-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .u-name { font-size: 1.1rem; font-weight: bold; color: var(--theme-color); max-width: 140px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .u-score { font-size: 1.8rem; font-weight: 800; color: var(--theme-color); }

        .control-bar { display: flex; align-items: center; gap: 8px; margin-bottom: 12px; }
        .btn-main { width: 55px; height: 50px; border: none; border-radius: 12px; font-size: 24px; color: white; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .btn-sub { background: var(--danger); box-shadow: 0 3px 0 #cf1322; }
        .btn-plus { background: var(--success); box-shadow: 0 3px 0 #389e0d; }
        .btn-main:active { transform: translateY(2px); box-shadow: none; }
        .val-input { flex: 1; min-width: 0; height: 50px; font-size: 20px; font-weight: bold; border: 2px solid #f0f0f0; background: #fafafa; border-radius: 12px; text-align: center; }

        .quick-nums { display: flex; gap: 6px; overflow-x: auto; padding-bottom: 4px; scrollbar-width: none; }
        .quick-nums::-webkit-scrollbar { display: none; }
        .num-chip { padding: 6px 12px; background: #f0f2f5; border-radius: 20px; font-size: 13px; color: #595959; flex-shrink: 0; border: 1px solid #e8e8e8; }
        .num-chip:active { background: var(--theme-color); color: white; border-color: var(--theme-color); }

        .hist-toggle { display: block; text-align: center; font-size: 12px; color: #bfbfbf; padding: 12px 0 0; text-decoration: none; }
        .hist-content { display: none; background: #fafafa; border-radius: 10px; padding: 8px; margin-top: 10px; max-height: 150px; overflow-y: auto; }
        .hist-item { display: flex; justify-content: space-between; align-items: center; font-size: 12px; padding: 6px 0; border-bottom: 1px dashed #eee; }
        .btn-revoke { color: var(--danger); font-size: 11px; border: 1px solid var(--danger); border-radius: 4px; padding: 2px 4px; }

        .settle-area { background: #1a1a1a; color: #fff; border-radius: 20px; padding: 20px; margin-top: 20px; margin-bottom: 40px; }
        .settle-row { display: flex; justify-content: space-between; margin-bottom: 10px; border-bottom: 1px solid #333; padding-bottom: 5px; }
        .btn-reset { width: 100%; background: none; border: 1px solid #444; color: #888; border-radius: 10px; padding: 12px; margin-top: 15px; }
    </style>
</head>
<body>

<div id="toast-container"></div>

<div class="card">
    <div class="header-group">
        <input type="text" id="nameInp" class="inp-name" placeholder="è¾“å…¥æˆå‘˜...">
        <button class="btn-add" onclick="addUser()">æ·»åŠ </button>
    </div>
    <div style="margin-top:12px; font-size:14px; color:#666;">
        <div style="display:flex; justify-content: space-between; align-items:center;">
            <span>è®¡ç®—æ¯”ä¾‹ï¼š<input type="number" id="rateInp" style="width:60px; text-align:center; border:1px solid #ddd; border-radius:4px;" value="100"> %</span>
            <span style="color:var(--danger); font-size:12px;" onclick="resetAll()">æ¸…ç©ºé‡ç½®</span>
        </div>
        <div id="checkBalanceResult"></div>
    </div>
</div>

<div id="userList"></div>

<div class="settle-area">
    <div style="font-weight:bold; margin-bottom:15px; border-bottom:1px solid #444; padding-bottom:8px;">ğŸ ç»“ç®—ä¸­å¿ƒ</div>
    <div id="settleList"></div>
    <button class="btn-reset" onclick="resetAll()">åˆ é™¤è®°å½•å¼€å§‹æ–°å±€</button>
</div>

<script>
    const colors = ['#1890ff', '#f5222d', '#52c41a', '#faad14', '#722ed1', '#13c2c2', '#eb2f96', '#fa8c16', '#a0d911', '#2f54eb'];
    let state = JSON.parse(localStorage.getItem('ScorePro_Color_v7')) || { users: [], rate: 100 };

    // æ–°å¢ï¼šæ˜¾ç¤º Toast å¼¹çª—
    function showToast(msg) {
        const toast = document.getElementById('toast-container');
        toast.innerText = msg;
        toast.style.display = 'block';
        clearTimeout(window.toastTimer);
        window.toastTimer = setTimeout(() => {
            toast.style.display = 'none';
        }, 1200); // 1.2ç§’åè‡ªåŠ¨æ¶ˆå¤±
    }

    function checkBalance() {
        if (state.users.length === 0) {
            document.getElementById('checkBalanceResult').innerHTML = "";
            return;
        }
        const sum = state.users.reduce((acc, u) => acc + u.score, 0);
        const displaySum = Math.abs(sum) < 0.001 ? 0 : (Number.isInteger(sum) ? sum : sum.toFixed(1));
        
        const container = document.getElementById('checkBalanceResult');
        if (displaySum === 0) {
            container.innerHTML = `<span class="balance-check balance-ok">å¹³è¡¡æ ¸å¯¹ï¼šè´¦ç›®å·²å¹³ (0)</span>`;
        } else {
            container.innerHTML = `<span class="balance-check balance-err">âš ï¸ è´¦ç›®ä¸å¹³ï¼šæ€»å·®é¢ ${displaySum > 0 ? '+' : ''}${displaySum}</span>`;
        }
    }

    function sync() {
        localStorage.setItem('ScorePro_Color_v7', JSON.stringify(state));
        render();
        checkBalance();
    }

    function addUser() {
        const name = document.getElementById('nameInp').value.trim();
        if(!name) return;
        const colorIdx = state.users.length % colors.length;
        state.users.push({ id: Date.now(), name, score: 0, logs: [], lastVal: 10, color: colors[colorIdx] });
        document.getElementById('nameInp').value = '';
        sync();
    }

    function mod(id, isAdd) {
        const user = state.users.find(u => u.id === id);
        const val = parseFloat(document.getElementById(`inp-${id}`).value) || 0;
        user.lastVal = val;
        const change = isAdd ? val : -val;
        user.score += change;
        user.logs.unshift({ id: Date.now(), time: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}), val: change });
        
        // --- ä¿®æ”¹ç‚¹ï¼šåœ¨æ•°æ®æ›´æ–°åå¢åŠ å¼¹çª—æç¤º ---
        showToast(`${user.name}ï¼š${change > 0 ? '+' : ''}${change}`);
        
        sync();
    }

    function revoke(userId, logId) {
        if(!confirm('æ’¤é”€è¿™ç¬”è®°å½•ï¼Ÿ')) return;
        const user = state.users.find(u => u.id === userId);
        const logIndex = user.logs.findIndex(l => l.id === logId);
        if (logIndex > -1) {
            const val = user.logs[logIndex].val;
            user.score -= val;
            user.logs.splice(logIndex, 1);
            showToast(`å·²æ’¤é”€ ${user.name} çš„è®°å½• (${val > 0 ? '+' : ''}${val})`);
            sync();
        }
    }

    function setQuickVal(userId, val) {
        const user = state.users.find(u => u.id === userId);
        user.lastVal = val;
        document.getElementById(`inp-${userId}`).value = val;
        localStorage.setItem('ScorePro_Color_v7', JSON.stringify(state));
    }

    function delUser(id) {
        if(confirm('åˆ é™¤æˆå‘˜ï¼Ÿ')) {
            state.users = state.users.filter(u => u.id !== id);
            sync();
        }
    }

    function resetAll() {
        if(confirm('æ¸…ç©ºæ‰€æœ‰è®°å½•ï¼Ÿ')) {
            state = { users: [], rate: 100 };
            sync();
        }
    }

    document.getElementById('rateInp').oninput = (e) => {
        state.rate = parseFloat(e.target.value) || 0;
        sync();
    };

    function toggleHist(id) {
        const content = document.getElementById(`content-${id}`);
        content.style.display = content.style.display === 'block' ? 'none' : 'block';
    }

    function render() {
        document.getElementById('rateInp').value = state.rate;
        const quickValues = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 20, 50, 100];

        document.getElementById('userList').innerHTML = state.users.map(u => `
            <div class="user-card" style="--theme-color: ${u.color}">
                <div class="user-header">
                    <div>
                        <span class="u-name">${u.name}</span>
                        <div style="font-size:10px; color:#ccc; margin-top:2px;" onclick="delUser(${u.id})">åˆ é™¤</div>
                    </div>
                    <div class="u-score">${u.score}</div>
                </div>
                <div class="control-bar">
                    <button class="btn-main btn-sub" onclick="mod(${u.id}, false)">âˆ’</button>
                    <input type="number" class="val-input" id="inp-${u.id}" value="${u.lastVal}" style="color:${u.color}; border-color:#f0f0f0">
                    <button class="btn-main btn-plus" onclick="mod(${u.id}, true)">ï¼‹</button>
                </div>
                <div class="quick-nums">
                    ${quickValues.map(v => `<div class="num-chip" onclick="setQuickVal(${u.id}, ${v})">${v}</div>`).join('')}
                </div>
                <a href="javascript:void(0)" class="hist-toggle" onclick="toggleHist(${u.id})">â–¼ æŸ¥çœ‹æ˜ç»† / æ’¤é”€è®°å½•</a>
                <div class="hist-content" id="content-${u.id}">
                    ${u.logs.map(l => `
                        <div class="hist-item">
                            <span>${l.time}</span>
                            <span style="color:${l.val>0? 'var(--success)':'var(--danger)'}; font-weight:bold">${l.val>0?'+':''}${l.val}</span>
                            <span class="btn-revoke" onclick="revoke(${u.id}, ${l.id})">æ’¤é”€</span>
                        </div>
                    `).join('') || '<div style="text-align:center;color:#ccc;font-size:11px">æš‚æ— æµæ°´è®°å½•</div>'}
                </div>
            </div>
        `).join('');

        document.getElementById('settleList').innerHTML = state.users.map(u => {
            const final = (u.score * (state.rate / 100)).toFixed(2);
            return `
                <div class="settle-row">
                    <span style="color:${u.color}">${u.name}</span>
                    <span style="color:${final >= 0 ? 'var(--success)' : 'var(--danger)'}">${final >= 0 ? '+' : ''}${final}</span>
                </div>
            `;
        }).join('') || '<div style="color:#666">è¯·æ·»åŠ æˆå‘˜å¼€å§‹è®°åˆ†</div>';
    }

    render();
    checkBalance();
</script>
</body>
</html>
